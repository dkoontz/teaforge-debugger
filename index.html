<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <title>TeaForge Debugger</title>
    <link rel="stylesheet" href="dist/styles.css">
</head>
<body class="h-screen overflow-hidden bg-base-100">
    <!-- Elm application mount point -->
    <div id="elm-app" class="h-full"></div>

    <!-- Load compiled Elm application -->
    <script src="dist/elm.js"></script>

    <!-- Load Split.js for resizable panels -->
    <script src="node_modules/split.js/dist/split.min.js"></script>

    <!-- Initialize Elm app and wire up ports -->
    <script>
        // Initialize the Elm application
        const app = Elm.Main.init({
            node: document.getElementById('elm-app'),
            flags: null
        });

        // Wire up Elm outgoing port to Electron APIs
        // The Elm app sends commands via the outgoing port, and we handle them here
        if (app.ports && app.ports.outgoing) {
            app.ports.outgoing.subscribe(async function(message) {
                const { type, payload } = message;

                try {
                    switch (type) {
                        case 'openFileDialog':
                            const dialogResult = await window.electron.openFileDialog();
                            sendToElm({
                                type: 'fileDialogResult',
                                payload: dialogResult
                            });
                            break;

                        case 'readFile':
                            const readResult = await window.electron.readFile(payload.path);
                            sendToElm({
                                type: 'fileReadResult',
                                payload: {
                                    path: payload.path,
                                    ...readResult
                                }
                            });
                            break;

                        case 'listFiles':
                            const listResult = await window.electron.listFiles(payload.path);
                            sendToElm({
                                type: 'fileListResult',
                                payload: {
                                    path: payload.path,
                                    ...listResult
                                }
                            });
                            break;

                        default:
                            console.warn('Unknown port message type:', type);
                    }
                } catch (error) {
                    console.error('Error handling port message:', error);
                    sendToElm({
                        type: 'error',
                        payload: {
                            originalType: type,
                            error: error.message
                        }
                    });
                }
            });
        }

        // Helper function to send messages to Elm via the incoming port
        function sendToElm(message) {
            if (app.ports && app.ports.incoming) {
                app.ports.incoming.send(message);
            }
        }

        // Initialize Split.js for resizable panels once Elm renders the elements
        // The sidebar and main content panels must have IDs 'split-sidebar' and 'split-main'
        function initSplit() {
            const sidebar = document.getElementById('split-sidebar');
            const main = document.getElementById('split-main');

            if (sidebar && main) {
                Split(['#split-sidebar', '#split-main'], {
                    sizes: [25, 75],           // Initial sizes: 25% sidebar, 75% main
                    minSize: [200, 400],       // Minimum sizes in pixels
                    gutterSize: 8,             // Width of the drag handle
                    cursor: 'col-resize',      // Cursor when hovering gutter
                    direction: 'horizontal',   // Horizontal split (side by side)
                    snapOffset: 0,             // Disable snapping
                    dragInterval: 1,           // Update on every pixel of drag
                    elementStyle: function(dimension, size, gutterSize) {
                        return {
                            'flex-basis': 'calc(' + size + '% - ' + gutterSize + 'px)'
                        };
                    },
                    gutterStyle: function(dimension, gutterSize) {
                        return {
                            'flex-basis': gutterSize + 'px'
                        };
                    }
                });
                return true;
            }
            return false;
        }

        // Use MutationObserver to detect when Elm renders the split elements
        const observer = new MutationObserver(function(mutations, obs) {
            if (initSplit()) {
                obs.disconnect(); // Stop observing once Split is initialized
            }
        });

        // Start observing DOM changes in the Elm app container
        observer.observe(document.getElementById('elm-app'), {
            childList: true,
            subtree: true
        });

        // Also try to initialize immediately in case elements already exist
        initSplit();
    </script>
</body>
</html>
